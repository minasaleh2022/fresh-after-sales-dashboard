
window.FRESH=(()=>{const governates=["القاهرة","الجيزة","الإسكندرية","الدقهلية","الشرقية","الغربية","المنيا"];const deviceTypes=["ثلاجة ديچيتال","ثلاجة ميكانيكال","ديب فريزر رأسي","ديب فريزر أفقي","ميني بار","مبرد مياه"];const branches=["مدينة نصر","المهندسين","سيدي جابر","طنطا","الزقازيق","المنصورة","المنيا"];const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;const today=new Date();const daysAgo=d=>new Date(Date.now()-d*86400000);const arr=[];for(let i=0;i<900;i++){const g=governates[rand(0,governates.length-1)];const dev=deviceTypes[rand(0,deviceTypes.length-1)];const br=branches[rand(0,branches.length-1)];const csat=rand(70,98);const ontime=rand(0,100)<85;const revisit=rand(0,100)<12;const age=rand(0,12);const status=["جديد","مجدول","قيد التنفيذ","مكتمل"][rand(0,3)];const spare=rand(0,1)?rand(150,1200):0;const revenue=rand(250,1500);const dt=daysAgo(rand(0,180));arr.push({g,dev,br,csat,ontime,revisit,age,status,spare,revenue,dt})}const data={filter(q){const maxAge=Number(q.range||90);return arr.filter(x=>(!q.governorate||x.g===q.governorate)&&(!q.deviceType||x.dev===q.deviceType)&&(!q.branch||x.br===q.branch)&&((today-x.dt)/86400000<=maxAge))},dims:{governates,deviceTypes,branches}};const store={_ensure(k){if(!localStorage.getItem(k))localStorage.setItem(k,JSON.stringify([]))},get(k){this._ensure(k);return JSON.parse(localStorage.getItem(k))},set(k,v){localStorage.setItem(k,JSON.stringify(v))},push(k,v){const a=this.get(k);a.push(v);this.set(k,a)},removeAt(k,i){const a=this.get(k);a.splice(i,1);this.set(k,a)}};if(!localStorage.getItem('deviceTypes'))store.set('deviceTypes',[...deviceTypes]);if(!localStorage.getItem('branches'))store.set('branches',[...branches]);const ui={initFilters(selGov,selDev,selBr){const elG=document.querySelector(selGov);const elD=document.querySelector(selDev);const elB=document.querySelector(selBr);const add=(el,list)=>{if(!el)return;el.innerHTML='';const opt=document.createElement('option');opt.value='';opt.textContent='الكل';el.appendChild(opt);list.forEach(x=>{const o=document.createElement('option');o.value=x;o.textContent=x;el.appendChild(o)})};if(elG)add(elG,data.dims.governates);if(elD)add(elD,store.get('deviceTypes'));if(elB)add(elB,store.get('branches'))},getQuery(){const gv=document.querySelector('#f-governorate')?.value||'';const dv=document.querySelector('#f-deviceType')?.value||'';const br=document.querySelector('#f-branch')?.value||'';const rg=document.querySelector('#f-range')?.value||'90';return{governorate:gv,deviceType:dv,branch:br,range:rg}},bindKPIs(d){const avg=k=>Math.round(d.reduce((s,x)=>s+x[k],0)/Math.max(1,d.length));const pct=k=>Math.round(100*d.filter(x=>x[k]).length/Math.max(1,d.length));const set=(id,val,suf='')=>{const el=document.getElementById(id);if(el)el.textContent=(val??'--')+suf};set('kpi-csat',avg('csat'),'%');set('kpi-ontime',pct('ontime'),'%');set('kpi-revisit',pct('revisit'),'%');const t=document.getElementById('kpi-tickets');if(t)t.textContent=d.length},bindAgingTable(id,d){const buckets={"0-1 يوم":0,"2-3 أيام":0,"4-7 أيام":0,">7 أيام":0};d.forEach(x=>{if(x.age<=1)buckets["0-1 يوم"]++;else if(x.age<=3)buckets["2-3 أيام"]++;else if(x.age<=7)buckets["4-7 أيام"]++;else buckets[">7 أيام"]++});const tbl=document.getElementById(id);if(!tbl)return;tbl.innerHTML=`<thead><tr><th>الفئة</th><th>عدد التذاكر</th></tr></thead><tbody>`+Object.entries(buckets).map(([k,v])=>`<tr><td>${{}}k</td><td>${{}}v</td></tr>`).join('')+`</tbody>`.replace('${{}}','').replace('${{}}','')}};const _chart=(id,cfg)=>{const ctx=document.getElementById(id);if(!ctx)return;if(ctx._inst)ctx._inst.destroy();ctx._inst=new Chart(ctx,cfg)};const charts={csatPerBranch(id,d){const map={};d.forEach(x=>{(map[x.br]??=[]).push(x.csat)});const labs=Object.keys(map);const vals=labs.map(k=>Math.round(map[k].reduce((s,v)=>s+v,0)/map[k].length));_chart(id,{type:'bar',data:{labels:labs,datasets:[{label:'CSAT %',data:vals}]},options:{plugins:{legend:{display:false}}}})},csatPerDevice(id,d){const map={};d.forEach(x=>{(map[x.dev]??=[]).push(x.csat)});const labs=Object.keys(map);const vals=labs.map(k=>Math.round(map[k].reduce((s,v)=>s+v,0)/map[k].length));_chart(id,{type:'bar',data:{labels:labs,datasets:[{label:'CSAT %',data:vals}]},options:{plugins:{legend:{display:false}}}})},csatPerRegion(id,d){const map={};d.forEach(x=>{(map[x.g]??=[]).push(x.csat)});const labs=Object.keys(map);const vals=labs.map(k=>Math.round(map[k].reduce((s,v)=>s+v,0)/map[k].length));_chart(id,{type:'bar',data:{labels:labs,datasets:[{label:'CSAT %',data:vals}]},options:{plugins:{legend:{display:false}}}})},ontimeTrend(id,d){const m={};d.forEach(x=>{const k=(x.dt.getFullYear()+"-"+(x.dt.getMonth()+1));(m[k]??=[]).push(x)});const labs=Object.keys(m).sort();const vals=labs.map(k=>Math.round(100*m[k].filter(x=>x.ontime).length/Math.max(1,m[k].length)));_chart(id,{type:'line',data:{labels:labs,datasets:[{label:'On-time %',data:vals}]},options:{plugins:{legend:{display:false}}}})},wip(id,d){const map={"جديد":0,"مجدول":0,"قيد التنفيذ":0,"مكتمل":0};d.forEach(x=>map[x.status]++);_chart(id,{type:'doughnut',data:{labels:Object.keys(map),datasets:[{data:Object.values(map)}]}})},sparePartsCost(id,d){const map={};d.forEach(x=>{map[x.dev]=(map[x.dev]||0)+x.spare});_chart(id,{type:'bar',data:{labels:Object.keys(map),datasets:[{label:'EGP',data:Object.values(map)}]},options:{plugins:{legend:{display:false}}}})},profitMargin(id,d){const service=150;const map={};d.forEach(x=>{const margin=x.revenue-x.spare-service;map[x.dev]=(map[x.dev]||0)+margin});_chart(id,{type:'bar',data:{labels:Object.keys(map),datasets:[{label:'Margin (EGP)',data:Object.values(map)}]},options:{plugins:{legend:{display:false}}}})}};return{data,ui,charts,store}})();
